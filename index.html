<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>学生吸烟、饮酒与心理健康数据分析</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #chart { width: 100%; height: 700px; }
    select { font-size: 16px; padding: 4px; margin-bottom: 20px; }
  </style>
</head>
<body>

<h1>学生吸烟、饮酒与心理健康数据分析</h1>

<select id="question-select">
  <option value="q1">1. 吸烟、酒精和心理健康之间相互作用</option>
  <option value="q2">2. 研究领域对于吸烟、喝酒的作用</option>
  <option value="q3">3. 年龄与吸烟、喝酒的关系</option>
  <option value="q4">4. 吸烟与饮酒之间是否有联系</option>
</select>

<div id="chart"></div>

<script>
  // 心理健康排序，确保顺序一致
  const health_order = ['优秀', '好', '平均', '低于平均水平', '差'];
  let data = [];

  // 读取 JSON 数据
  d3.json("data.json").then(raw => {
    data = raw;
    updateChart("q1");
  });

  document.getElementById("question-select").addEventListener("change", function () {
    updateChart(this.value);
  });

  // 唯一有序
  function uniqueSorted(arr, order) {
    if (order) {
      return order.filter(val => arr.includes(val));
    }
    return Array.from(new Set(arr));
  }

  function updateChart(q) {
    if (q === "q1") {
      // 1. 桑基图
      let smoke_labels = uniqueSorted(data.map(d => d.吸烟频率).filter(Boolean));
      let alcohol_labels = uniqueSorted(data.map(d => d.酒精消费频率).filter(Boolean));
      let health_labels = health_order;

      let labels = smoke_labels.concat(alcohol_labels).concat(health_labels);

      let smoke_idx = Object.fromEntries(smoke_labels.map((k, i) => [k, i]));
      let alcohol_idx = Object.fromEntries(alcohol_labels.map((k, i) => [k, i+smoke_labels.length]));
      let health_idx = Object.fromEntries(health_labels.map((k, i) => [k, i+smoke_labels.length+alcohol_labels.length]));

      let links_source = [], links_target = [], links_value = [];

      // 吸烟 -> 酒精
      smoke_labels.forEach(s => {
        let filtered = data.filter(d => d.吸烟频率 === s);
        let counts = {};
        filtered.forEach(d => {
          if (d.酒精消费频率) counts[d.酒精消费频率] = (counts[d.酒精消费频率] || 0) + 1;
        });
        alcohol_labels.forEach(a => {
          if (counts[a]) {
            links_source.push(smoke_idx[s]);
            links_target.push(alcohol_idx[a]);
            links_value.push(counts[a]);
          }
        });
      });

      // 酒精 -> 心理健康
      alcohol_labels.forEach(a => {
        let filtered = data.filter(d => d.酒精消费频率 === a);
        let counts = {};
        filtered.forEach(d => {
          if (d.心理健康) counts[d.心理健康] = (counts[d.心理健康] || 0) + 1;
        });
        health_labels.forEach(h => {
          if (counts[h]) {
            links_source.push(alcohol_idx[a]);
            links_target.push(health_idx[h]);
            links_value.push(counts[h]);
          }
        });
      });

      Plotly.newPlot("chart", [{
        type: "sankey",
        orientation: "h",
        node: {
          label: labels,
          pad: 15,
          thickness: 20,
          color: "lightblue"
        },
        link: { source: links_source, target: links_target, value: links_value }
      }], {
        title: "吸烟、饮酒与心理健康关系（桑基图）"
      });

    } else if (q === "q2") {
      // 2. 研究领域 vs 吸烟频率堆叠条形图
      let fields = uniqueSorted(data.map(d => d.研究领域).filter(Boolean));
      let freqSet = uniqueSorted(data.map(d => d.吸烟频率).filter(Boolean));
      // 构建交叉表
      let grouped = {};
      fields.forEach(f => grouped[f] = {});
      data.forEach(d => {
        if (!grouped[d.研究领域]) grouped[d.研究领域] = {};
        if (!grouped[d.研究领域][d.吸烟频率]) grouped[d.研究领域][d.吸烟频率] = 0;
        grouped[d.研究领域][d.吸烟频率]++;
      });

      let traces = freqSet.map(freq => {
        return {
          x: fields,
          y: fields.map(f => grouped[f]?.[freq] || 0),
          name: freq,
          type: 'bar'
        };
      });

      Plotly.newPlot("chart", traces, {
        barmode: "stack",
        title: "不同研究领域吸烟频率分布",
        xaxis: { title: "研究领域" },
        yaxis: { title: "人数" }
      });

    } else if (q === "q3") {
      // 3. 年龄 vs 吸烟频率箱线图
      let freqSet = uniqueSorted(data.map(d => d.吸烟频率).filter(Boolean));
      // 年龄字段可能为范围字符串
      let ageToMid = ageStr => {
        if (!ageStr) return null;
        if (typeof ageStr === "number") return ageStr;
        let match = String(ageStr).match(/(\d+)-(\d+)/);
        if (match) return (parseInt(match[1]) + parseInt(match[2])) / 2;
        let num = parseInt(ageStr);
        return isNaN(num) ? null : num;
      };
      let traces = freqSet.map(freq => {
        let ages = data.filter(d => d.吸烟频率 === freq)
                       .map(d => ageToMid(d.年龄))
                       .filter(v => v !== null && !isNaN(v));
        return ages.length > 0 ? {
          y: ages,
          name: freq,
          type: 'box'
        } : null;
      }).filter(Boolean);

      Plotly.newPlot("chart", traces, {
        title: "不同吸烟频率对应年龄分布",
        yaxis: { title: "年龄" }
      });

    } else if (q === "q4") {
      // 4. 吸烟 vs 酒精 热力图
      let freqX = uniqueSorted(data.map(d => d.酒精消费频率).filter(Boolean));
      let freqY = uniqueSorted(data.map(d => d.吸烟频率).filter(Boolean));
      let matrix = freqY.map(y =>
        freqX.map(x =>
          data.filter(d => d.吸烟频率 === y && d.酒精消费频率 === x).length
        )
      );

      Plotly.newPlot("chart", [{
        z: matrix,
        x: freqX,
        y: freqY,
        type: 'heatmap',
        colorscale: 'Viridis'
      }], {
        title: '吸烟频率与酒精消费频率交叉热力图',
        xaxis: { title: "酒精消费频率" },
        yaxis: { title: "吸烟频率" }
      });
    }
  }
</script>
</body>
</html>
